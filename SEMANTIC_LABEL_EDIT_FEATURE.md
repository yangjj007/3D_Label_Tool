# 语义标签编辑功能说明

## 功能概述

为3D模型打标系统添加了语义标签在线编辑功能，允许用户直接在界面上修改已存在的语义标签，并将修改后的标签保存回原模型文件（GLB/GLTF格式）。

## 实现的功能

### 1. 语义标签显示面板增强
- **位置**: 主编辑界面右上角
- **触发条件**: 当点击包含语义标签的材质对象时显示
- **新增元素**: 在标签面板右上角添加了编辑图标（铅笔图标）

### 2. 语义标签编辑弹窗
- **组件位置**: `src/components/SemanticLabelEditDialog/index.vue`
- **功能特性**:
  - 显示当前选中材质的名称
  - 多行文本编辑框，支持最多2000字符
  - 实时字数统计
  - 保存/取消操作

### 3. 标签保存机制
保存时会执行以下操作：

#### a. 更新模型对象
```javascript
mesh.userData.semanticLabel = newLabel
```

#### b. 导出模型文件
- 使用 `GLTFExporter` 导出模型
- 将 `userData.semanticLabel` 写入 GLTF JSON 的 `node.extras.semanticLabel` 和 `mesh.extras.semanticLabel`

#### c. 文件持久化
- **本地存储**: 保存到 IndexedDB（更新原文件记录）
- **服务器同步**: 如果文件来自服务器，自动上传到服务器的 `labeled_files` 文件夹
- 更新文件元数据，标记为已打标状态（`hasLabels: true`）

## 使用方法

### 用户操作流程

1. **加载包含语义标签的模型**
   - 在左侧文件列表中选择一个已打标的模型文件
   - 或上传新的包含语义标签的 GLB/GLTF 文件

2. **查看语义标签**
   - 在3D视图中点击模型的任一材质对象
   - 如果该材质包含语义标签，右上角会显示"语义标签"面板

3. **编辑语义标签**
   - 点击语义标签面板右上角的编辑图标（铅笔图标）
   - 在弹出的对话框中修改标签内容
   - 点击"保存并写入模型"按钮

4. **保存结果**
   - 系统会自动将新标签写入模型文件
   - 本地 IndexedDB 和服务器都会更新
   - 显示保存成功提示

## 技术实现细节

### 1. 组件架构

```
src/views/modelEdit/index.vue (主视图)
  └── 语义标签面板
      └── 编辑图标 (触发编辑)
          └── SemanticLabelEditDialog (编辑弹窗)
```

### 2. 数据流

```
1. 用户点击编辑图标
   ↓
2. 传递参数: mesh, model, fileInfo, fileId
   ↓
3. 显示编辑弹窗，填充当前标签
   ↓
4. 用户修改并保存
   ↓
5. 更新 mesh.userData.semanticLabel
   ↓
6. 导出 GLB (包含标签)
   ↓
7. 保存到 IndexedDB
   ↓
8. 上传到服务器 (如果需要)
   ↓
9. 触发回调，更新 UI
```

### 3. GLB 标签写入格式

在 GLTF JSON 中的存储结构：

```json
{
  "nodes": [
    {
      "name": "Material_001",
      "extras": {
        "semanticLabel": "这是一个语义标签内容..."
      }
    }
  ],
  "meshes": [
    {
      "name": "Material_001",
      "extras": {
        "semanticLabel": "这是一个语义标签内容..."
      }
    }
  ]
}
```

### 4. 核心代码文件

| 文件 | 说明 |
|------|------|
| `src/components/SemanticLabelEditDialog/index.vue` | 编辑弹窗组件 |
| `src/views/modelEdit/index.vue` | 主视图集成 |
| `src/utils/OffscreenRenderModel.js` | GLB 导出参考实现 |

## 支持的文件格式

- ✅ **GLB** (推荐) - 二进制 GLTF 格式
- ✅ **GLTF** - JSON + 二进制资源
- ❌ **OBJ** - 暂不支持（需要单独实现）
- ❌ **FBX** - 暂不支持
- ❌ **STL** - 暂不支持

## 注意事项

1. **文件格式限制**
   - 只有 GLB/GLTF 格式支持语义标签写入
   - 其他格式会显示警告提示

2. **权限要求**
   - 需要模型已加载到场景中
   - 需要选中包含语义标签的材质对象

3. **数据同步**
   - 如果文件来自服务器，会自动同步到服务器
   - 本地编辑会保存到 IndexedDB
   - 服务器同步失败不影响本地保存

4. **性能考虑**
   - 大型模型导出可能需要几秒钟
   - 保存过程中会显示加载状态
   - 不建议频繁保存大文件

## 未来改进方向

1. **批量编辑**: 支持一次编辑多个材质的标签
2. **标签模板**: 提供常用标签模板快速填充
3. **历史记录**: 记录标签修改历史，支持撤销/重做
4. **标签验证**: 添加标签格式验证和内容检查
5. **其他格式支持**: 扩展到 OBJ、FBX 等格式
6. **智能建议**: 基于现有标签提供智能补全

## 开发者信息

- **实现日期**: 2025-12-19
- **相关 Issue**: 语义标签编辑功能需求
- **测试状态**: 已完成代码实现，待用户测试

## 反馈与支持

如有问题或建议，请提交 Issue 或联系开发团队。

